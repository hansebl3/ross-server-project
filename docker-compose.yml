version: '3.8'

# Unified Docker Compose for Ross Dashboard System
# Usage: docker compose up -d --build

services:
  # ----------------------------------------------------------------
  # 1. Main Dashboard (Port 8501)
  # ----------------------------------------------------------------
  dashboard:
    build:
      context: .
      dockerfile: my-dashboard/Dockerfile
    container_name: ross-dashboard
    network_mode: "host"
    volumes:
      - ./my-dashboard:/app
      - ~/.ssh:/root/.ssh:ro
    restart: unless-stopped
    environment:
      - TZ=Asia/Seoul
      # Linking to Postgres now (Dashboard doesn't use DB directly yet but good to have)
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

  # ----------------------------------------------------------------
  # 2. Analize CSV (Port 8502)
  # ----------------------------------------------------------------
  analize-csv:
    build:
      context: .
      dockerfile: AnalizeCSV/Dockerfile
    container_name: ross-analize-csv
    network_mode: "host"
    volumes:
      - ./AnalizeCSV:/app
      - ./shared:/app/shared
    command: [ "streamlit", "run", "src/app.py", "--server.port=8502", "--server.address=0.0.0.0" ]
    restart: unless-stopped
    environment:
      - TZ=Asia/Seoul
      - PYTHONPATH=/app
      - MARIADB_HOST=${MARIADB_HOST}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      - MARIADB_DB=${MARIADB_DB}

  # ----------------------------------------------------------------
  # 3. PostgreSQL Service (Port 5432)
  # ----------------------------------------------------------------
  postgres:
    image: postgres:15
    container_name: ross-postgres
    network_mode: "host"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TZ=Asia/Seoul
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
